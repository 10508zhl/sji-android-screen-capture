<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>SJI-ASC Management</title>
  <script>
    (function() {
      if(Number(navigator.userAgent.match(/msie *(\d+)/i)||{}) < 10){
        alert('Your Internet Explorer\'s version is &lt; 10, it is not supported. Please use 10+ or Chrome 20+, Firefox 20+, Safari 6+');
      }
    })();
  </script>
  <link rel="stylesheet" type="text/css" href="common.css?adminKey=@adminKey">
  <style>
    .streamingIndicator {background-color: blue; color: yellow; font-family: "courier new", courier, monospace; font-size: 100%; white-space: pre; z-index: 98}
    .recordingIndicator {background-color: #0000A0; color: yellow; font-family: "courier new", courier, monospace; font-size: 100%; white-space: pre; z-index: 98}
    #totalRecordedFileSize.highlight {color: blue; font-weight: bold}
    .disconnected {background-color: #ededf4}
  </style>
</head>
<body onunload="">
  <div id="darkMask" style="display: none">Disconnected. Auto reconnect every 10 seconds...</div>
  <form class="toolbar" style="width: 100%; text-align: center; position: fixed; top: 2px; left: 0" target="_self">
    <input type="hidden" name="adminKey" value="#adminKey"/>

    <button type="submit">Using</button>
    <label class="infoWithTip" title="Frames per Second. @MIN_FPS >= value <= @MAX_FPS">
      Rate<input type="text" name="fps" size="2" value="@fps"/>
    </label>
    <label class="infoWithTip" title="Example: 0.5 or 800x400 or 800x or x400">
      Scale<input type="text" name="scale" size="10" value="@scale"/>
    </label>
    <span>Rotate
      <label><input type="radio" name="rotate" value=""/>0°</label>
      <label><input type="radio" name="rotate" value="90"/>90°</label>
      <label><input type="radio" name="rotate" value="270"/>270°</label>
    </span>
  </form>
  <form action="/deviceControl" style="width: 100%; text-align: center" target="_self">
    <input type="hidden" name="adminKey" value="#adminKey"/>
    <input type="hidden" name="fps" value="@fps"/><!--only used for "Start Recording"-->
    <input type="hidden" name="scale" value="@scale"/><!--only used for "Start Recording"-->
    <input type="hidden" name="rotate" value="@rotate"/><!--only used for "Start Recording"-->

    <div class="toolbar" style="width: 100%; text-align: center; position: fixed; top: 30px; left: 0">
      <button type="submit" name="action" value="setAccessKey" title="Set Access Key for selected devices">
        Set Key
      </button>
      <label title="Access Key is used as querystring accessKey=theKey of URL when access device's live capture or recorded files">
        <input type="text" name="accessKey" size="8" value=""/>
      </label>
      <button type="submit" name="action" value="unsetAccessKey" title="Unset Access Key for selected devices">
        Unset
      </button>
      <span style="background-color: darkgray">&nbsp;</span>
      <button type="submit" name="action" value="startRecording" formtarget="resultIFrame" title="Stop existing recording and start new recording fore selected devices">
        Record
      </button>
      <button type="submit" name="action" value="stopRecording" formtarget="resultIFrame" title="Stop existing recording for selected devices">
        Stop
      </button>
      <button type="submit" name="action" value="deleteRecordedFiles" formtarget="resultIFrame" title="Delete recorded files for selected devices" onclick="return confirm('Sure?')">
        DeleteV
      </button>
      <span style="background-color: darkgray">&nbsp;</span>
      <button type="submit" name="action" value="deleteImages" formtarget="resultIFrame" title="Delete saved images for selected devices" onclick="return confirm('Sure?')">
        DeleteImg
      </button>
    </div>
    <table border="1px" id="device_tbl" style="width:100%; margin-top:63px; margin-bottom: 30px">
      <tr>
        <th rowspan="2"><label class="fillParent"><input type="checkbox" id="device_chkAll" checked/></label></th>
        <th colspan="2" title="Android device connected actually or scanned from recorded files">
          Device
        </th>
        <th colspan="6">Video</th>
      </tr>
      <tr>
        <th title="SN is the Device Serial Number. You can confirm it by &quot;adb devices&quot; command" class="infoWithTip">SN</th>
        <th title="Access Key is used as querystring accessKey=theKey of URL when access device's live capture or recorded files" class="infoWithTip">Key</th>
        <th colspan="2" title="Use multipart/x-mixed-replace response. Supported by Chrome, Firefox, IE10+">
          <label><input type="radio" name="type" value="apng"/>AnimatedPNG</label>
        </th>
        <th colspan="2" title="Use multipart/x-mixed-replace response. Supported by Chrome, Firefox, IE10+">
          <label><input type="radio" name="type" value="ajpg"/>AnimatedJPG</label>
        </th>
        <th colspan="2" title="Use google VP8 video format. Supported by Chrome(Fast), Firefox(but slow)">
          <label><input type="radio" name="type" value="webm"/>WebM</label>
        </th>
      </tr>
      <!--repeatBegin-->
      <tr>
        <td rowspan="3" style="text-align: left; vertical-align: top"><label class="fillParent"><input type="checkbox" name="device" value="#device" class="device_chk" checked/></label></td>
        <td style="text-align: left; vertical-align: middle">
          #device
        </td>
        <td class="#styleName_AccessKey_disp" style="text-align: left; vertical-align: middle; border-left: 1px dashed lightgray; border-bottom: 1px dashed lightgray">
          #accessKey_disp
        </td>
        <td style="text-align: left; vertical-align: top; white-space: nowrap">
          <a href="@stream_web/liveViewer?device=@device&accessKey=@accessKey&type=apng&fps=@fps&scale=@scale&rotate=@rotate" target="live view #device">
            Live View
          </a>
        </td>
        <td rowspan="2" style="text-align: center; vertical-align: middle; border-left: 1px dashed lightgray; border-bottom: 1px dashed lightgray">
          <span class="streamingIndicator" id="streamingStatus_apng_@device"></span>
        </td>
        <td style="text-align: left; vertical-align: top; white-space: nowrap">
          <a href="@stream_web/liveViewer?device=@device&accessKey=@accessKey&type=ajpg&fps=@fps&scale=@scale&rotate=@rotate" target="live view #device">
            Live View
          </a>
        </td>
        <td rowspan="2" style="text-align: center; vertical-align: middle; border-left: 1px dashed lightgray; border-bottom: 1px dashed lightgray">
          <span class="streamingIndicator" id="streamingStatus_ajpg_@device"></span>
        </td>
        <td style="text-align: left; vertical-align: top; white-space: nowrap">
          <a href="@stream_web/liveViewer?device=@device&accessKey=@accessKey&type=webm&fps=@fps&scale=@scale&rotate=@rotate" target="live view #device" class="caution" title="These action will interrupt any recording or live viewing on this device due to technique reason(on working)">
            Live View
          </a>
          <a href="@stream_web/liveViewer?device=@device&accessKey=@accessKey&type=webm&fps=@fps&scale=@scale&rotate=@rotate&recordOption=sync" target="live view #device" class="confused" title="Record until close view">
            r
          </a>
          <a href="@stream_web/liveViewer?device=@device&accessKey=@accessKey&type=webm&fps=@fps&scale=@scale&rotate=@rotate&recordOption=async" target="live view #device" class="confused" title="Record in background">
            R
          </a>
        </td>
        <td rowspan="2" style="text-align: center; vertical-align: middle; border-left: 1px dashed lightgray; border-bottom: 1px dashed lightgray">
          <span class="streamingIndicator" id="streamingStatus_webm_@device"></span>
        </td>
      </tr>
      <tr>
        <td rowspan="2" colspan="2" style="text-align: left; vertical-align: middle; border-top: 1px dashed lightgray">
          <div class="#devinfo_class" title="Gray means disconnected device. &quot;Unknown&quot; means timeout or device is offline or not authenticated(Please check whether there is a popup displaying in android) or just an invalid serial number">
            #devinfo
          </div>
          <a href="@stream_web/capture?device=@device&accessKey=@accessKey&type=png&scale=@scale&rotate=@rotate" target="screenshot #device" class="caution" title="This action is slow! Do NOT use this frequently when Recording or Live Viewing! You can use &quot;Save&quot; button in in Live View page">
            PNG
          </a>
          <a href="@stream_web/capture?device=@device&accessKey=@accessKey&type=jpg&scale=@scale&rotate=@rotate" target="screenshot #device" class="caution" title="This action is slow! Do NOT use this frequently when Recording or Live Viewing! You can use &quot;Save&quot; button in in Live View page">
            JPG
          </a>
          <a href="/downloadRawScreenshot?adminKey=@adminKey&device=@device" target="resultIFrame" title="Download Android Screen Raw Image" class="internal">
            Raw
          </a>
          <a href="@stream_web/listSavedImages?device=@device&accessKey=@accessKey" target="screenshot #device" title="List Images you extracted from live view or recorded video">
            List Saved
          </a>
          <span style="background-color: darkgray">&nbsp;</span>
          <a href="/getDeviceLog?adminKey=@adminKey&device=@device" target="asc_log_#device" title="Android-Side Utility Log" class="internal">
            Log
          </a>
          <a href="/getDeviceCpuMemTop?adminKey=@adminKey&device=@device" target="asc_top_#device" title="Android CPU Memory Usage" class="internal">
            Top
          </a>
        </td>
        <td style="text-align: left; vertical-align: top; white-space: nowrap; border-top: 1px dashed lightgray; border-bottom: 1px dashed lightgray">
          <a href="@stream_web/fileViewer?device=@device&accessKey=@accessKey&type=apng&fileIndex=0&fps=@fps" target="recorded #device">
            Recorded Videos
          </a>
        </td>
        <td style="text-align: left; vertical-align: top; white-space: nowrap; border-top: 1px dashed lightgray; border-bottom: 1px dashed lightgray">
          <a href="@stream_web/fileViewer?device=@device&accessKey=@accessKey&type=ajpg&fileIndex=0&fps=@fps" target="recorded #device">
            Recorded Videos
          </a>
        </td>
        <td style="text-align: left; vertical-align: top; white-space: nowrap; border-top: 1px dashed lightgray; border-bottom: 1px dashed lightgray">
          <a href="@stream_web/fileViewer?device=@device&accessKey=@accessKey&type=webm&fileIndex=0" target="recorded #device">
            Recorded Videos
          </a>
        </td>
      </tr>
      <tr>
        <td colspan="2" style="text-align: left; vertical-align: middle; white-space: nowrap">
          <a href="/deviceControl?action=toggleRecording&device=@device&adminKey=@adminKey&type=apng&fps=@fps&scale=@scale&rotate=@rotate" target="resultIFrame"
             class="button toggleRecording_@device" id="toggleRecording_apng_@device" style="visibility: hidden">
            Record/Stop
          </a>
          <span class="recordingIndicator" id="recordingStatus_apng_@device"></span>
        </td>
        <td colspan="2" style="text-align: left; vertical-align: middle; white-space: nowrap">
          <a href="/deviceControl?action=toggleRecording&device=@device&adminKey=@adminKey&type=ajpg&fps=@fps&scale=@scale&rotate=@rotate" target="resultIFrame"
             class="button toggleRecording_@device" id="toggleRecording_ajpg_@device" style="visibility: hidden">
            Record/Stop
          </a>
          <span class="recordingIndicator" id="recordingStatus_ajpg_@device"></span>
        </td>
        <td colspan="2" style="text-align: left; vertical-align: middle; white-space: nowrap">
          <a href="/deviceControl?action=toggleRecording&device=@device&adminKey=@adminKey&type=webm&fps=@fps&scale=@scale&rotate=@rotate" target="resultIFrame"
             class="button toggleRecording_@device" id="toggleRecording_webm_@device" style="visibility: hidden">
            Record/Stop
          </a>
          <span class="recordingIndicator" id="recordingStatus_webm_@device"></span>
        </td>
      </tr>
      <!--repeatEnd-->
    </table>
  </form>
  <div class="expandable" style="position: fixed; top: 1px; left: 1px">
    <div>Help</div>
    <ul style="font-size: small">
      <li>
        <div class="infoWithTip">To Enable Authentication on Stream Web...</div>
        <ul>
          <li>
            Use "Set Key" to attach access key to selected devices.
            (The Access Key is used as querystring accessKey=theKey of URL when access device's live capture or recorded files)
          </li>
        </ul>
      </li>
      <li>
        <div class="infoWithTip">To Enable Remote Access to Stream Web...</div>
        <ul>
          <li>
            Set ip = "*" or some explicit IP address in stream.json file.
          </li>
          <li>
            Optionally, set ssl.on = true to Enable SSL on Stream Web.
          </li>
          <li>
            Restart this application.
          </li>
        </ul>
      </li>
      <li>
        <div class="infoWithTip" >To Enable SSL on Stream Web...</div>
        <ul>
          <li>
            Set ssl.on = true in stream.json file.
          </li>
          <li>
            Optionally, configure certificateFilePath or replace PKCS12 file ./ssl/StreamWeb.pfx with yours.
          </li>
          <li>
            Restart this application.
          </li>
        </ul>
      </li>
      <li>
        <div class="infoWithTip">To Enable Authentication on Admin Web...</div>
        <ul>
          <li>
            Set <b style="color:blue">adminKey</b> in stream.json file to any string you like. Example: "adminKey": "xxxx"
          </li>
          <li>
            Restart this application.
          </li>
          <li>
            Open this menu page by the URL appended with adminKey=yourAdminKey querystring. Example: https://127.0.0.1/?adminKey=xxxx
          </li>
        </ul>
      </li>
      <li>
        <div class="infoWithTip">To Enable Remote Access to Admin Web...</div>
        <ul>
          <li>
            Set adminWeb.ip = "*" or some explicit IP address in stream.json file.
          </li>
          <li>
            Optionally, set adminWeb.ssl.on = true to Enable SSL on Admin Web.
          </li>
          <li>
            Restart this application.
          </li>
        </ul>
      </li>
      <li>
        <div class="infoWithTip" >To Enable SSL on Admin Web...</div>
        <ul>
          <li>
            Set adminWeb.ssl.on = true in stream.json file.
          </li>
          <li>
            Optionally, configure adminWeb.certificateFilePath or replace PKCS12 file ./ssl/AdminWeb.pfx with yours.
          </li>
          <li>
            Restart this application.
          </li>
        </ul>
      </li>
    </ul>
  </div>
  <div class="expandable" style="position: fixed; top: 1px; right: 1px">
    <div style="width: 86px">AdminTool</div>
    <div>
      <div style="margin-bottom: 8px">
        <a class="button" href="/stopServer?adminKey=@adminKey" target="_self" style="color: red" onclick="return confirm('Sure?')">
          Stop Server
        </a>
        <a class="button" href="/restartAdb?adminKey=@adminKey" target="_self" style="color: red" onclick="return confirm('Sure?')">
          Restart ADB
        </a>
      </div>
      <form action="/getLog" target="asc log">
        <input type="hidden" name="adminKey" value="#adminKey"/>

        <button type="submit">Get Log</button>
        <label>
          <input type="checkbox" name="logDownload" value="true"/>Download
        </label>
        <label>
          <label><input type="radio" name="logDate" value="today" checked/>Today</label>
          <label><input type="radio" name="logDate" value="yesterday"/>Yesterday</label>
        </label>
        <div style="margin-left: 100px" title="Start, End(not included) position of log file. Same as string.slice(start, end) method. Minus position means totalLength-absolutePosition. Both empty means all content.">
          <label class="infoWithTip">
            Start<input type="text" name="logStart" size="10" value="@logStart"/>
          </label>
          <label class="infoWithTip">
            End<input type="text" name="logEnd" size="10" value="@logEnd"/>
          </label>
        </div>
      </form>
      <div>
        <a class="button" href="/reloadResource?adminKey=@adminKey" target="_self">Reload</a>
        Html,Css,Js,Recorded Files...
      </div>
      <div>
        <a class="button" href="/prepareDeviceFile?adminKey=@adminKey" target="_self">Prepare</a>
        Device File Forcibly
      </div>
      <div>
        <a class="button" href="/var?adminKey=@adminKey&ffmpegDebugLog=@ffmpegDebugLog_negVal" target="_self">#ffmpegDebugLog_negBtn</a>
        FFMPEG Debug Log
      </div>
      <div>
        <a class="button" href="/var?adminKey=@adminKey&ffmpegStatistics=@ffmpegStatistics_negVal" target="_self">#ffmpegStatistics_negBtn</a>
        FFMPEG Statistics Log
      </div>
      <div>
        <a class="button" href="/var?adminKey=@adminKey&remoteLogAppend=@remoteLogAppend_negVal" target="_self">#remoteLogAppend_negBtn</a>
        Android-Side Utility(FFMPEG etc.) Append Mode Log
      </div>
      <div>
        <a class="button" href="/var?adminKey=@adminKey&logHttpReqAddr=@logHttpReqAddr_negVal" target="_self">#logHttpReqAddr_negBtn</a>
        Log HTTP Request IP And Port
      </div>
      <div>
        <a class="button" href="/var?adminKey=@adminKey&reloadDevInfo=@reloadDevInfo_negVal" target="_self">#reloadDevInfo_negBtn</a>
        Reload Device Info Forcibly On Menu
      </div>
      <div>
        <a class="button" href="/var?adminKey=@adminKey&logImageDecoderDetail=@logImageDecoderDetail_negVal" target="_self">#logImageDecoderDetail_negBtn</a>
        Log Animated PNG/JPG Decoder
      </div>
      <div>
        <a class="button" href="/var?adminKey=@adminKey&forceUseFbFormat=@forceUseFbFormat_negVal" target="_self">#forceUseFbFormat_negBtn</a>
        Force Use pixel format of fb_var_screeninfo
      </div>
      <form action="/useStreamWebIp" target="_self">
        <input type="hidden" name="adminKey" value="#adminKey"/>

        <button type="submit">Using</button>
        <label class="infoWithTip" title="You can use this to change the ip address of all public links such as &quot;Live View&quot; concerned with Stream Web">
          StreamWeb IP<input type="input" name="ip" value="@streamWebIP"/>
        </label>
      </form>
      <form action="/setTempImageFileLife" target="_self">
        <input type="hidden" name="adminKey" value="#adminKey"/>

        <button type="submit">Set</button>
        <label class="infoWithTip" title="When Live View or Playback Recorded File, Temporary Image File will be produced. This is for you use &quot;Save&quot; functionality so that it will be renamed to normal file for you download or view">
          Temporary Image File Life<input type="input" name="tempImageLifeMilliseconds" value="@tempImageLifeMilliseconds"/>ms
        </label>
      </form>
    </div>
  </div>
  <table style="position: fixed; bottom: 0; left: 0; width: 100%; background-color: #fafafa">
    <tr style="vertical-align: bottom">
      <td style="text-align: left; vertical-align: bottom; width: 50%; padding-left: 1px">
        <iframe name="resultIFrame" style="width: 100%; min-height: 27px; max-height: 27px; height: 27px; background-color: ghostwhite; border: 1px solid lightgray; margin: 0; padding: 0; display: block"></iframe>
      </td>
      <td style="text-align: right; vertical-align: bottom; padding-left: 3px">
        <span id="streamingSpeed" style="background-color: blue; color: white; height: 27px"></span>
      </td>
      <td style="text-align: right; vertical-align: bottom; padding-right: 2px">
        <span id="totalRecordedFileSize" style="background-color: ghostwhite; border: 1px solid lightgray; height: 27px">Storage: @totalRecordedFileSize_disp</span>
      </td>
    </tr>
  </table>

  <script src="jquery-2.0.3.js?adminKey=@adminKey" type="text/javascript"></script>

  <script>
    var $device_chk = $('.device_chk'), $device_chkAll = $('#device_chkAll'), chkSum = $device_chk.length;
    $device_chkAll.on('click', function () {
      $device_chk.prop('checked', $.prop(this, 'checked'));
      chkSum = $device_chk.length;
    });
    $('#device_tbl').on('click', '.device_chk', function () {
      chkSum += $.prop(this, 'checked') ? 1 : -1;
      $device_chkAll.prop('checked', chkSum === $device_chk.length);
      $device_chkAll.prop('indeterminate', chkSum !== $device_chk.length && chkSum !== 0);
    });
    var appVer = '@appVer';
    var ver = '';
    function queryStatus() {
      $.ajax('/status?adminKey=@adminKey&ver=' + ver, {timeout: 60 * 1000})
        .done(function (status) {
          if (status.appVer != appVer) {
            //refresh page if menu version is changed
            setTimeout(function(){
              document.location.reload(true);
            }, 250);
            return;
          }
          //otherwise, update some html elements

          ver = status.ver;
          var recordingFlagMap = {};
          $.each(status.data, function (elementId, text) {

            //show "Stop" button and hide all other "Record" button when recording
            if (elementId.indexOf('recordingStatus_') >= 0) {

              var parts = elementId.split('_'), device = parts[2], type = parts[1];
              recordingFlagMap[device] = recordingFlagMap[device] || (text ? true : false);
              if (text) {
                var theToggleElement = document.getElementById('toggleRecording_' + type + '_' + device);
                //hide all other "Record/Stop" button
                $('.' + 'toggleRecording_' + device).not(theToggleElement).css('visibility', 'hidden');
                //change target "Record/Stop" button's href and title
                theToggleElement.href = theToggleElement.href.replace(/toggle|start/, 'stop');
                $(theToggleElement).text('Stop').css('visibility', 'visible');
              }
            }

            //set status text normally.  strange! span.innerText does not work on Firefox
            var theElement = document.getElementById(elementId);
            if (theElement) {
              $(theElement).text(text);
            }
          });

          //show all "Record" button if no any recording
          $.each(recordingFlagMap, function (device, recordingFlag) {
            if (!recordingFlag) {
              $('.' + 'toggleRecording_' + device).each(function (i, theToggleElement) {
                theToggleElement.href = theToggleElement.href.replace(/toggle|stop/, 'start');
                $(theToggleElement).text('Record').css('visibility', 'visible');
              });
            }
          });

          //set totalRecordedFileSize style
          if (status.data.totalRecordingCount) {
            $('#totalRecordedFileSize').addClass('highlight');
          } else {
            $('#totalRecordedFileSize').removeClass('highlight');
          }

          $('#darkMask').hide();

          queryStatus();
        })
        .fail(function (jqXHR, textStatus) {
          if (textStatus === 'timeout') {
            queryStatus();
          } else {
            $('#darkMask').show();
            setTimeout(queryStatus, 10*1000);
          }
        });
    }
    queryStatus();
  </script>
</body>
</html>